<ul class="toasts">
	{#each toasts as toast (toast.id)}
		<li class="toast" style="background: {toast.background};" out:animateOut>
			<div class="content">
				{toast.msg}
			</div>
			<div 
					 class="progress" 
					 style="animation-duration: {toast.timeout}ms;"
					 on:animationend="removeToast(toast.id)">
			</div>
		</li>	
	{/each}
</ul>

<style>
	:global(.toasts) {
		list-style: none;
		position: fixed;
		top: 0;
		right: 0;
		padding: 0;
		margin: 0;
		z-index: 10;
	}
	
	:global(.toasts) > .toast {
		position: relative;
		margin: 10px;
		min-width: 30vw;
		position: relative;
		animation: animate-in 350ms forwards;
		color: #fff;
	}
	
	:global(.toasts) > .toast > .content {
		padding: 10px;
		display: block;
		font-weight: 500;
	}
	
	:global(.toasts) > .toast > .progress {
		position: absolute;
		bottom: 0;
		background-color: rgb(0, 0, 0, 0.3);
		height: 6px;
    width: 100%;
	  animation-name: shrink;
	  animation-timing-function: linear;
	  animation-fill-mode: forwards;
	}
	
	:global(.toasts) > .toast:before,
	:global(.toasts) > .toast:after {
			content:"";
			position:absolute;
			z-index:-1;
			top:50%;
			bottom:0;
			left:10px;
			right:10px;
			border-radius:100px / 10px;
	}
	
	:global(.toasts) > .toast:after {
			right:10px;
			left:auto;
			transform:skew(8deg) rotate(3deg);
	}
	
	@keyframes animate-in { 
		0% { 
			height: 0; 
			opacity: 0; 
			transform: scale(1.15) translateX(20px);
		}
		100% { 
			height: 47px;
			opacity: 1; 
			transform: scale(1) translateX(0);
		}
	}
	
	@keyframes shrink { 
		0% { 
			width: 100%; 
		}
		100% { 
			width: 0%; 
		}
	}
	
</style>

<script>
	export default {
		data () {
			return {
				count: 0,
				toasts: [ ],
				themes: {
					danger: '#bb2124',
					success: '#22bb33',
					warning: '#f0ad4e',
					info: '#5bc0de',
					default: '#aaaaaa'
				}
			}
		},

		transitions: { 
			animateOut(node, { delay = 0, duration = 300 }) {
				return {
					delay,
					duration,
					css: t => t > .5 
						? `opacity: ${(t-.5) * 1}; transform: scaleY(${(t-.5)*1});` 
						: `opacity: 0; height: ${t * 2 * 47}px;`
				};
			}
		},

		methods: {
			createToast (msg, theme, timeout) {
				const { toasts, themes, count } = this.get()
				const background = themes[theme] || themes['default']
				toasts.unshift({
					id: count,
					msg, 
					background, 
					timeout, 
					width: '100%'
				})
				this.set({ toasts, count: count + 1 })
			},
			
			removeToast(id) { 
				const { toasts } = this.get()
				this.set({
					toasts: toasts.filter(t => t.id != id)
				})
			}, 
			
			show (msg, timeout = 3000, theme = 'default') {
				this.createToast(msg, theme, timeout)
			},
			
			danger (msg, timeout) {
				this.show(msg, timeout, 'danger')
			},
			
			warning (msg, timeout) {
				this.show(msg, timeout, 'warning')
			},
			
			info (msg, timeout) {
				this.show(msg, timeout, 'info')
			},
			
			success (msg, timeout) {
				this.show(msg, timeout, 'success')
			},
			
			hide () {
				this.set({ shown: false })
			}
		}
	}
</script>